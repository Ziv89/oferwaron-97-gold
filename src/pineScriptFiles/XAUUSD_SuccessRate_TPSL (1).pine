
//@version=5
indicator("XAUUSD 1min - Success Rate + TP/SL", overlay=true)

rsi = ta.rsi(close, 14)
[macdLine, signalLine, _] = ta.macd(close, 12, 26, 9)
sqz = ta.ema(close - ta.sma(close, 20), 12) - ta.ema(close - ta.sma(close, 20), 26)
atr = ta.atr(14)
kde = 100 * ta.stdev(close, 5) / close
rmi = ta.rsi(close, 7)
rmiTrendUp = rmi > rmi[1]
rmiTrendDown = rmi < rmi[1]
lowKDE = kde < 7

longCond = rsi < 40 and ta.crossover(macdLine, signalLine) and sqz > 0 and rmiTrendUp and lowKDE
shortCond = rsi > 60 and ta.crossunder(macdLine, signalLine) and sqz < 0 and rmiTrendDown and lowKDE

// TP/SL
tpMult = 1.3
slMult = 0.8
riskReward = tpMult / slMult

var label successLabel = na
var float entryPrice = na
var float sl = na
var float tp = na
var int trades = 0
var int wins = 0

if (longCond or shortCond)
    entryPrice := close
    sl := close - slMult * atr * (longCond ? 1 : -1)
    tp := close + tpMult * atr * (longCond ? 1 : -1)
    trades += 1

    label.delete(successLabel)
    successPerc = trades > 0 ? (wins * 100.0) / trades : na
    clr = successPerc >= 95 ? color.green :
          successPerc >= 90 ? color.blue :
          successPerc >= 80 ? color.orange : color.gray

    successLabel := label.new(
        bar_index, high + 3 * syminfo.mintick,
        text=str.tostring(successPerc, "#.0") + "%",
        style=label.style_label_down,
        color=clr, textcolor=color.white, size=size.large)

if not na(entryPrice)
    if (longCond and high >= tp) or (shortCond and low <= tp)
        wins += 1
    if (longCond and low <= sl) or (shortCond and high >= sl)
        entryPrice := na

