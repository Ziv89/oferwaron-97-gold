//@version=5
strategy("XAUUSD Strategy - Real Success + Signal Labels", overlay=true, default_qty_type=strategy.percent_of_equity, default_qty_value=10)

// === אינדיקטורים ===
[macdLine, signalLine, _] = ta.macd(close, 12, 26, 9)
rsi = ta.rsi(close, 14)
atr = ta.atr(14)
vwapLine = ta.vwap

// === תנאים לאיתותים ===
longCond = ta.crossover(macdLine, signalLine) and rsi > 50 and close > vwapLine
shortCond = ta.crossunder(macdLine, signalLine) and rsi < 50 and close < vwapLine

// === TP/SL לפי ATR ===
longTP = close + atr * 2
longSL = close - atr * 1.5
shortTP = close - atr * 2
shortSL = close + atr * 1.5

// === פתיחת עסקאות ===
if longCond
    strategy.entry("Long", strategy.long)
    strategy.exit("Long TP/SL", from_entry="Long", limit=longTP, stop=longSL)
    label.new(x=bar_index, y=high, text="לונג - הצלחה: " + str.tostring((strategy.wintrades * 100) / strategy.closedtrades, "#.0") + "%", style=label.style_label_up, color=color.green, textcolor=color.white, size=size.normal)

if shortCond
    strategy.entry("Short", strategy.short)
    strategy.exit("Short TP/SL", from_entry="Short", limit=shortTP, stop=shortSL)
    label.new(x=bar_index, y=low, text="שורט - הצלחה: " + str.tostring((strategy.wintrades * 100) / strategy.closedtrades, "#.0") + "%", style=label.style_label_down, color=color.red, textcolor=color.white, size=size.normal)

// === תווית אחוז הצלחה כללית על הגרף ===
successPerc = strategy.closedtrades > 0 ? (strategy.wintrades * 100) / strategy.closedtrades : 0

color successColor = na
if successPerc >= 95
    successColor := color.green
else if successPerc >= 90
    successColor := color.blue
else if successPerc >= 80
    successColor := color.yellow
else
    successColor := color.red

var label lbl = na
if not na(lbl)
    label.delete(lbl)

lbl := label.new(
    x=bar_index + 2,
    y=high,
    text="Success: " + str.tostring(successPerc, "#.0") + "%",
    style=label.style_label_down,
    color=successColor,
    textcolor=color.white,
    size=size.large
)