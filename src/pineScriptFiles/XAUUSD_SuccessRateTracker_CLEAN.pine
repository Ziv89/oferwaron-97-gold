
//@version=5
indicator("XAUUSD 1min - Success Rate Tracker", overlay=true)

// === הגדרות TP/SL ===
tpMult = 1.3
slMult = 0.8
riskReward = tpMult / slMult

// === אינדיקטורים עיקריים ===
rsi = ta.rsi(close, 7)
[macdLine, signalLine, _] = ta.macd(close, 12, 26, 9)
sqz = ta.ema(close - ta.sma(close, 10), 6) - ta.ema(close - ta.sma(close, 6), 13)
atr = ta.atr(7)
kde = 100 * ta.stdev(close, 10) / close
lowKDE = kde < 7

rmi = ta.rsi(close, 7)
rmiTrendUp = rmi > rmi[1]
rmiTrendDown = rmi < rmi[1]

longCond = rsi < 40 and ta.crossover(macdLine, signalLine) and sqz > 0 and rmiTrendUp and lowKDE
shortCond = rsi > 60 and ta.crossunder(macdLine, signalLine) and sqz < 0 and rmiTrendDown and lowKDE

// === מעקב אחר הצלחה ===
var float entryPrice = na
var float sl = na
var float tp = na
var int trades = 0
var int wins = 0
var label successLabel = na

if (longCond or shortCond)
    entryPrice := close
    sl := close - slMult * atr * (longCond ? 1 : -1)
    tp := close + tpMult * atr * (longCond ? 1 : -1)
    trades += 1

    if not na(successLabel)
        label.delete(successLabel)

    successPerc = trades > 0 ? (wins * 100.0) / trades : na
    clr = successPerc >= 95 ? color.green :
          successPerc >= 90 ? color.blue :
          successPerc >= 80 ? color.orange : color.gray

    successLabel := label.new(
      bar_index, high + 3 * syminfo.mintick,
      text = str.tostring(successPerc, "#.0") + "%",
      style = label.style_label_down,
      color = clr,
      textcolor = color.white,
      size = size.large
    )

// === בדיקת תוצאה ===
if not na(entryPrice)
    if (longCond and high >= tp) or (shortCond and low <= tp)
        wins += 1
    if (longCond and low <= sl) or (shortCond and high >= sl)
        entryPrice := na
